<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel='import' href='../../bower_components/iron-icons/iron-icons.html'>
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../lazy-library.html">
<link rel="import" href="../css/form/polymer-gridstack-style.html">
<link rel="import" href="../css/appDrawer-styles.html">
<link rel="import" href="../components/form/lazy-controls.html">
<script src="../lib/utils.js"></script>

<link rel="import" href="../components/form/common/remove-widget-link.html">

<dom-module id="form-design-page">
  <template>
    <!-- <link rel="stylesheet" href="./../bower_components/bootstrap/dist/css/bootstrap.min.css" /> -->
    <link rel="stylesheet" href="../../dist/gridstack.css"/>
    <link rel="stylesheet" href="../../dist/gridstack-extra.css"/>
    <link rel="stylesheet" href="../../css/tree-css/zTreeStyle/zTreeStyle.css" />

    <!-- <link rel="stylesheet" type="text/css" href="../../dist/dhtmlx/dhtmlx.css">
    <link rel="stylesheet" type="text/css" href="../../dist/dhtmlx/dhtmlxfbext.css">
    <link rel="stylesheet" type="text/css" href="../../dist/dhtmlx/formbuilder.css"> -->
    <style include="polymer-gridstack-style iron-flex appDrawer-styles">
      :host {
        display: block;
        --background-color:#ff817b;
        --padding-all:15px 0px;
        --app-drawer-scrim-background: none;
        --app-drawer-width: 400px;
        --app-drawer-content-container: {
            border: 1px solid #ddd;
            /*padding: 10px;*/
        };
        --paper-tab-background: {
          background: -webkit-linear-gradient(bottom, #fff 0%, #fafafa 100%);
          background: -moz-linear-gradient(bottom,  #fff 0%, #fafafa 100%);
          background: -o-linear-gradient(bottom,  #fff 0%, #fafafa 100%);
          background: -ms-linear-gradient(bottom,  #fff 0%, #fafafa 100%);
          background: linear-gradient(to bottom,  #fff 0%, #fafafa 100%);
        };
      }

      .container-grid {
        /*margin-left: 420px;*/
        margin-top: 10px;
        /*padding: 10px;*/
        box-shadow: 0 2px 4px rgba(0,0,0,0.04),0 1px 4px rgba(0,0,0,0.12);
        background-color: #fff;
        border: 1px solid #ddd;
        /*height: calc(100vh - 80px);
        overflow-y: auto;*/
      }
      .form-layout.collapsed .container-grid {
        /*margin-left: 40px;*/
      }
      .form-layout {
        position: relative;
      }
      .grid-stack-item-content {
        /*background: white;*/
        color: #2c3e50;
        font-family: 'Indie Flower', cursive;
        text-align: center;
        font-size: 14px;
      }
      .grid-stack {
        /*background: lightgoldenrodyellow;*/
        min-height: 50px;
        /*border: 1px solid #ddd;*/
        margin-bottom: 5px;
      }
      .remove {
        font-size: 12px;
      }

      .grid-stack-item-content {
          color: #2c3e50;
          text-align: center;
          border: 1px dashed #ddd;
          /*padding-top: 5px;*/
          /*background-color: #18bc9c;*/
      }
      .grid-stack-item-content.active {
        border-color: #27aade;
      }
      .grid-stack > .grid-stack-item > .grid-stack-item-content {
        left: 5px!important;
        right: 5px!important;
      }
      .grid-stack > .grid-stack-item {
        /*min-width: 100px!important;*/
      }
      .drawer-contents {
        height: 100%;
        overflow: auto;
      }
      .generate-grid .grid-stack-item-content {
        border: none;
      }
      .tool-menu {
        padding-bottom: 5px;
        height: 26px;
      }
      .tool-menu .title {
        font-size: 12px;
      }
      .toolbox {
        display: inline-block;
      }
      .toolbox .tool-btn {
        position: relative;
        padding: 6px;
        font-size: 12px;
        color: #222;
        cursor: pointer;
        text-decoration: none;
      }
      .toolbox .tool-btn iron-icon {
        width: 20px;
        height: 20px;
      }

      paper-tabs.header-tabs {
        @apply(--paper-tab-background);

        height: 42px;
        border-bottom: 1px solid #ddd;
        padding-left: 5px;

        --paper-tabs-selection-bar-color: #01b1f8;
        --paper-tab-ink: #cdcdcd;
        --paper-tabs-selection-bar: {
        }
      }
      paper-tabs.header-tabs paper-tab:hover {
        background: #eee;
      }
      paper-tabs.header-tabs paper-tab.iron-selected:hover {
        background: none;
      }
      .tab-content {
        padding: 10px 15px;
        height: calc(100vh - 120px);
        overflow-y: auto;
      }
      paper-tabs.drawer-tabs {
        height: 54px;
        font-weight: normal;

        --paper-tabs-selection-bar-color: #fff;
        --paper-tab-ink: #cdcdcd;
      }
      /*paper-tabs.drawer-tabs paper-tab:focus {
        --paper-tab-content: {
          font-weight: normal;
        }
      }*/
      .lay_block > .lay_column {
        border-left: 1px dotted #dfdfdf;
        min-height: 100px;
        padding-left: 10px;
        padding-right: 10px;
      }
      .lay_block > .lay_column:first-child {
        border-left: none;
      }
      .lay_block {
        padding: 10px;
      }
      .lay_column .lay_block.row {
        margin: 10px 0 0;
        border: 1px solid #dfdfdf;
      }

      .generate-grid .lay_block.row, .generate-grid .lay_block > .lay_column {
        border: none;
      }
    </style>

    <div class="device-xs visible-xs"></div>
    <div class="device-sm visible-sm"></div>
    <div class="device-md visible-md"></div>
    <div class="device-lg visible-lg"></div>
    <div class="device-xl visible-xl"></div>
    <div class="container-fluid form-layout layout horizontal" id="formLayout">
        <business-tree></business-tree>
        <control-tree></control-tree>
        <div class="container-grid flex">
          <paper-tabs class="header-tabs" selected="{{viewType}}" scrollable hide-scroll-buttons>
            <paper-tab>表单设计</paper-tab>
            <paper-tab>设计预览</paper-tab>
          </paper-tabs>
          <iron-pages selected="{{viewType}}">
            <section class="tab-content" id="formDesign">
              <div class="lay_block row">
                <!-- <div class="grid-stack" id="gridStack">
                </div> -->
                <!-- <div class="col-md-12">
                    <div class="grid-stack grid-stack-6" id="gridStack">
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="grid-stack grid-stack-6" id="gridStack2">
                    </div>
                </div> -->
                <div class="col-md-12 lay_column" width='12' id="col_treeLeft_1">
                  <div class="grid-stack" id="gridStack">
                  </div>
                  <!-- <div class="lay_block row"><div class="col-md-12 lay_column"><div class="grid-stack" id="gridStack2"></div><operation-menu></operation-menu></div></div> -->
                  <operation-menu></operation-menu>
                </div>
              </div>
              <!-- <div id="formBuilder" style="width:100%;height:400px"></div> -->
            </section>
            <section class="tab-content generate-grid" id="designPreview">
              <div class="lay_block row">
                <!-- <div class="col-md-12 lay_column" width='12'>
                  <div class="grid-stack generate-grid" id="generateGrid">
                  </div>
                </div> -->
              </div>
            </section>
          </iron-pages>

        </div>


        <app-drawer id="controlConfigDrawer" align="right" swipe-open class="map-add">
          <div class="drawer-contents">
            <app-toolbar class="add-header drawer-header">
              <div class="flex">
                <!-- [[activeProperties.Category]] 控件属性 -->
                <paper-tabs class="drawer-tabs" selected="{{controlDrawerType}}" autoselect scrollable hide-scroll-buttons>
                  <paper-tab>[[activeProperties.Category]] 控件属性</paper-tab>
                  <dom-if if="[[_computeDrawerFieldShown(activeProperties.Category)]]">
                    <template><paper-tab>[[activeProperties.Category]] 控件字段属性</paper-tab></template>
                  </dom-if>
                </paper-tabs>
              </div>
              <paper-icon-button icon="chevron-right" on-tap="hideConfigDrawer"></paper-icon-button>
            </app-toolbar>
            <!-- <control-properties active-control="[[activeControl]]" active-properties="{{activeProperties}}"></control-properties> -->
            <iron-pages selected="{{controlDrawerType}}">
              <section>
                <control-properties active-control="[[activeControl]]" active-properties="{{activeProperties}}"></control-properties>
              </section>
              <dom-if if="[[_computeDrawerFieldShown(activeProperties.Category)]]">
                <template>
                  <section>
                    <control-field-properties active-control="[[activeControl]]" active-properties="{{activeProperties}}"></control-field-properties>
                  </section>
                </template>
              </dom-if>

            </iron-pages>
          </div>
        </app-drawer>

        <!-- <app-drawer id="controlFieldDrawer" align="right" swipe-open class="map-add">
          <div class="drawer-contents">
            <app-toolbar class="add-header">
              <div class="flex">编辑字段属性</div>
              <paper-icon-button icon="chevron-right" on-tap="_hideFieldDrawer"></paper-icon-button>
            </app-toolbar>
            <control-field-properties active-control="[[activeControl]]" active-properties="{{activeProperties}}"></control-field-properties>
          </div>
        </app-drawer> -->
    </div>
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class FormDesignPage extends Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element) {
      static get is() { return 'form-design-page'; }
      static get properties() {
        return {
          page: {
            type: String,
            observer: '_pageChanged'
          },

          activeControl: {
            type: Object,
          },

          activeProperties: {
            type: Object,
            notify: true,
          },

          activeFieldProperties: {
            type: Object,
            notify: true,
          },

          isFormShown: {
            type: Boolean,
            value: false
          },

          viewType: {
            type: Number,
            value: 0,
            observer: '_viewTypeChanged'
          },

          controlDrawerType: {
            type: Number,
            value: 0,
          },

        };
      }

      ready(){
        this.addEventListener('iron-resize', this._resizeGrid.bind(this));
        this.addEventListener('add-widget', this.addNewWidget.bind(this));
        this.addEventListener('remove-widget', this._removeWidget.bind(this));
        this.addEventListener('set-active-control', this._setAvtiveControl.bind(this));
        this.addEventListener('open-drawer', this.showConfigDrawer.bind(this));
        this.addEventListener('close-drawer', this.hideConfigDrawer.bind(this));
        this.addEventListener('add-new', this._addNew.bind(this));
        this.addEventListener('remove-new', this._removeNew.bind(this));
        this.addEventListener('select-control', this._selectControl.bind(this));
        super.ready();

      }

      _initFormBuilder() {
        var _this = this;
        dhtmlxEvent(window, "load", function(){
    			var app = dhtmlxApp.start("formbuilder", _this.$.formBuilder);
    			dhtmlxEvent(window, "unload", function(){
    				app.unload();
    			});
    		});
      }

      _pageChanged(page) {
        if (page === 'form') {
          var _businessTree = this.root.querySelector('business-tree');
          if (_businessTree) {
            _businessTree._initTree();
          }
          var _controlTree = this.root.querySelector('control-tree');
          if (_controlTree) {
            _controlTree._initTree();
          }
          this._newGridstack();
          // this._initFormBuilder();
        }
      }

      _setAvtiveControl(e) {
        var _control = e.detail.control, _isDelete = e.detail.isDelete;
        var _businessTree = this.root.querySelector('business-tree');
        var _controlTree = this.root.querySelector('control-tree');
        if (_isDelete) {
          _controlTree._cancelSelectControlNode(_control.Category);
          this.activeControl = null;
          this.activeProperties = {};
          return;
        }
        this._clearActiveItem();
        if (_control.parentNode && _control.parentNode.classList.contains('grid-stack-item-content')) {
          _control.parentNode.classList.add('active');
        }
        this.activeControl = _control;
        var _properties = this.activeControl.constructor.properties;
        // console.log(_properties);
        var activeProperties = {};
        for (var key in _properties) {
          activeProperties[key] = this.activeControl[key];
        }
        this.activeProperties = activeProperties;
        _businessTree._selectControlNode(activeProperties.Category);
        var _controlItem = _control.parentNode.parentNode;
        if (_controlItem.id) {
          _controlTree._selectControlNode(_controlItem.id);
        }
        // console.log(_businessTree.selectNode);
        this.activeControl.fieldPropertites = _businessTree.selectNode;
        this.activeFieldProperties = _businessTree.selectNode;
      }

      _clearActiveItem() {
        var _activeItem = this.root.querySelector('.grid-stack-item-content.active');
        if (_activeItem && _activeItem.classList.contains('active')) {
          _activeItem.classList.remove('active');
        }
      }

      _saveConfig() {
        var _activeControl = this.activeControl;
        var _label = this.$.controlLabel.value;
        if (_label) {
          _activeControl.label = _label;
        }
      }

      showConfigDrawer(e) {
        // if (this.$.controlConfigDrawer.hasAttribute('opened')) {
        //   this.closeMacDetailDrawer();
        // }
        this.$.controlConfigDrawer.open();
      }

      hideConfigDrawer() {
        this.$.controlConfigDrawer.close();
      }

      _showFieldDrawer() {
        this.$.controlFieldDrawer.open();
      }

      _hideFieldDrawer() {
        this.$.controlFieldDrawer.close();
      }

      isBreakpoint(alias) {
        var _lay = this.root.querySelector('.device-' + alias);
        return $(_lay).is(':visible');
      }

      _resizeGrid() {
        if (this.grid) {
          if (this.isBreakpoint('xs')) {
              $(this.$.gridSize).text('One column mode');
          } else if (this.isBreakpoint('sm')) {
              this.grid.setGridWidth(3);
              $(this.$.gridSize).text(3);
          } else if (this.isBreakpoint('md')) {
              this.grid.setGridWidth(6);
              $(this.$.gridSize).text(6);
          } else if (this.isBreakpoint('lg')) {
              this.grid.setGridWidth(12);
              $(this.$.gridSize).text(12);
          }
        }
      }

      _newGridstack() {
        var options = {
            float: false,
            width: 12,
            // removable: '.trash',
            // removeTimeout: 100,
            acceptWidgets: '.grid-stack-item',
            // verticalMargin: 5,
            draggable: {
              handle: '.grid-stack-item-content',
              scroll: false,
              appendTo: 'parent'
            }
        };
        $(this.$.gridStack).gridstack(options);
        // var grid = $(this.$.gridStack).data('gridstack');
        // grid.cellHeight(30);
        // console.log(grid.cellHeight());

        // var serializeWidgetMap = function(items) {
        //     console.log(items);
        //     console.log(items[0].x);
        // };

        // $(this.$.gridStack).on('change', function(event, items) {
        //     serializeWidgetMap(items);
        // });
        var _controlTree = this.root.querySelector('control-tree');
        var _this = this;
        $(this.$.gridStack).on('added', function(event, items) {
          for (var i = 0; i < items.length; i++) {
            var element = items[i].el[0];
            var node = $(element).data('_gridstack_node');
            var _control = element.firstChild.firstChild;
            if (_control) {
              _control.ID = Utils.makeRecID();
              _control.isFormShown = _this.isFormShown;
              _control.Position = { x: items[i].x, y: items[i].y };
              _control.Size = { width: items[i].width, height: items[i].height };
            }
            var parentEl = element.parentNode.parentNode;
            // console.log(element.id, parentEl.id);
            _controlTree.moveTreeNode(parentEl.id, element.id);
          }
        });

        $(this.$.gridStack).on('dragstop', function(event, ui) {
            var grid = this;
            var element = event.target;
            var node = $(element).data('_gridstack_node');
            var _control = element.firstChild.lastChild;
            if (_control) {
              _control.Position = {
                x: node.x, y: node.y
              }
              _control.Size = {
                width: node.width, height: node.height
              }
            }
            console.log(node);
            console.log(_control);
        });

        // console.log(this.grid);
        // this.addNewWidget = function () {
        //     var node = this.items.pop() || {
        //                 x: 12 * Math.random(),
        //                 y: 5 * Math.random(),
        //                 width: 1 + 3 * Math.random(),
        //                 height: 1 + 3 * Math.random()
        //             };
        //     // this.grid.addWidget($('<div class="grid-stack-item"><div class="grid-stack-item-content"></div></div>'),
        //     //     node.x, node.y, node.width, node.height);
        //     this.grid.addWidget($('<div class="grid-stack-item"><div class="grid-stack-item-content"><add-item></add-item></div></div>'),
        //         node.x, node.y, node.width, node.height);
        //     // return false;
        // }.bind(this);

        // $('#add-new-widget').click(this.addNewWidget);
        // this.$.addNewWidget.addEventListener('click', function(e){
        //   this.addNewWidget();
        // }.bind(this))
      }

      addNewWidget(e) {
        var _node = e.detail.node;
        // console.log(_node);
        this.items = [
            {x: 0, y: 0, width: 2, height: 2},
            {x: 3, y: 1, width: 1, height: 2},
            {x: 4, y: 1, width: 1, height: 1},
            {x: 2, y: 3, width: 3, height: 1},
            {x: 2, y: 5, width: 1, height: 1}
        ];
        this.grid = $(this.$.gridStack).data('gridstack');
        var node = this.items.pop() || {
                    x: 12 * Math.random(),
                    y: 5 * Math.random(),
                    width: 1 + 3 * Math.random(),
                    height: 1 + 3 * Math.random()
                };
        var {html, width} = this._getWidget(_node.name);
        // this.grid.addWidget($('<div class="grid-stack-item"><div class="grid-stack-item-content"></div></div>'),
        //     node.x, node.y, node.width, node.height);
        // this.grid.addWidget($('<div class="grid-stack-item"><div class="grid-stack-item-content"><add-item></add-item></div></div>'),
        //     node.x, node.y, node.width, node.height);
        // this.grid.addWidget($('<div class="grid-stack-item"><div class="grid-stack-item-content"><add-item></add-item></div></div>'),
        //     1, 1, 2, 1);

        if (html) {
          var _nodeId = this._addTreeNodes({ parentId: 'col_treeLeft_1', name: _node.name });
          this.isFormShown = false;
          this.grid.addWidget($('<div class="grid-stack-item" id="item_' + _nodeId + '"><div class="grid-stack-item-content"><remove-widget-link></remove-widget-link>'+ html +'</div></div>'),
              1, 1, width, 1, true);
        }

      }

      _getWidget(type) {
        type = type.toLowerCase();
        var html = '', width = 1;
        switch (type) {
          case 'label':
            html = '<control-label></control-label>';
            width = 1;
            break;
          case 'input':
            html = '<control-input></control-input>';
            width = 2;
            break;
          case 'button':
            html = '<control-button></control-button>';
            width = 1;
            break;
          case 'select':
            html = '<control-select></control-select>';
            width = 2;
            break;
          case 'labelinput':
            html = '<control-label-input></control-label-input>';
            width = 3;
            break;
          case 'checkbox':
            html = '<control-checkbox></control-checkbox>';
            width = 1;
            break;
          case 'radio':
            html = '<control-radio></control-radio>';
            width = 1;
            break;
          default:

        }
        return {
          html, width
        }
      }

      _removeWidget(e) {
        // console.log(e.target);
        // var els = this.$.gridStack.querySelectorAll('.grid-stack-item');
        // console.log(els);
        // this.grid.remove_widget(els[1]);
        var _item = e.detail;
        var _grid = _item.parentNode;
        var _newField = $(_grid).data('gridstack');
        _newField.removeWidget(_item);
        this._removeTreeNodes(_item.id);
      }

      _saveGrid() {
        var _grid = this.$.gridStack;
        this.serializedData = _.map(_grid.querySelectorAll('.grid-stack-item'), function (el) {
            // el = $(el);
            var node = $(el).data('_gridstack_node');
            var _control = el.firstChild.lastChild;
            _control.Position = {
              x: node.x, y: node.y
            }
            _control.Size = {
              width: node.width, height: node.height
            }
            var _properties = _control.constructor.properties;
            // console.log(_properties);
            var activeProperties = {};
            for (var key in _properties) {
              activeProperties[key] = _control[key];
            }
            return activeProperties;
        }, this);
        // console.log(this.serializedData);
        // console.log(JSON.stringify(this.serializedData));
        this._saveColumn();
      }

      _generateGrid() {
        // this.grid = $(this.$.gridStack).data('gridstack');
        this.isFormShown = true;
        if (this.serializedData && this.serializedData.length) {
          this._serializedGrid(this.serializedData);
          return;
        }
        // $.getJSON('/src/lib/controlDef.json', function(data){
        //   this._serializedGrid(data);
        // }.bind(this));
      }

      _serializedGrid(data) {
        // console.log(data);
        if (!this.$.generateGrid) {
          return;
        }
        var options = {
            float: true,
            width: 12,
            // verticalMargin: 5,
            draggable: {
              handle: '.grid-stack-item-content',
              scroll: false,
              appendTo: 'parent'
            }
        };
        $(this.$.generateGrid).gridstack(options);
        this.generateGrid = $(this.$.generateGrid).data('gridstack');
        this.generateGrid.removeAll();
        for (var i = 0; i < data.length; i++) {
          var _item = data[i];
          var {html, width} = this._getWidget(data[i].Category);

          if (html) {
            var start = html.indexOf('<'), end = html.indexOf('>');
            var el1 = document.createElement(html.substring(start + 1, end));
            // console.log(_item);
            for (var key in _item) {
              el1[key] = _item[key];
            }
            el1.isFormShown = true;
            var _gridItem = $('<div class="grid-stack-item"></div>'), _itemContent = $('<div class="grid-stack-item-content"></div>');
            _itemContent.append(el1);
            _gridItem.append(_itemContent);
            this.generateGrid.addWidget(_gridItem, _item.Position.x, _item.Position.y, _item.Size.width, _item.Size.height);
            // this.generateGrid.addWidget($('<div class="grid-stack-item"><div class="grid-stack-item-content">'+ _el1 +'</div></div>'),
            //     _item.Position.x, _item.Position.y, _item.Size.width, _item.Size.height);
          }
        }
        this.generateGrid.disable();
      }

      _viewTypeChanged(viewType) {
        if (viewType) {
          this._saveGrid();
          this._generateGrid();
        }
      }

      _computeDrawerFieldShown(category) {
        this.controlDrawerType = 0;
        return category !== 'Label' && category !== 'Button';
      }

      _addNew(e) {
        var {self, tag, name} = e.detail;
        if (tag == 1) {
          this._addNewColumn(self);
        } else if (tag == 2) {
          this._addNewBlock(self);
        } else if (tag == 4) {
          this._addNewField(self, name);
        }
      }

      _removeNew(e) {
        var {self, tag} = e.detail;
        this._removeColumn(self);
      }

      _addNewColumn(self) {
        var _block = self.parentNode.parentNode;
        var _columns = $(_block).find('>.lay_column');
        // console.log(_columns);
        var _this = this, _col = 12;
        if (_columns.length) {
          _col = 12 / (_columns.length + 1);
          _columns.each(function(i, column){
            var _list = _this._setColumnWidth(column.classList, _col);
            column.className = _list;
            column.setAttribute('width', _col);
            // console.log(column.scrollHeight);
          });
        }
        // $(_block).append('<div class="col-md-' + _col + ' lay_column"><div class="grid-stack"></div><operation-menu></operation-menu></div>');
        var _nodeId = this._addTreeNodes({ parentId: _block.id, name: 'column' });
        var _colId = _nodeId ? 'col_' + _nodeId : '';
        var _layColumn = $('<div class="col-md-' + _col + ' lay_column" width=' + _col + ' id="' + _colId+ '"><div class="grid-stack"></div><operation-menu></operation-menu></div>');
        $(_block).append(_layColumn);
        var _grid = _layColumn[0].querySelector('.grid-stack');
        this._initAddGridstack(_grid);
        var _prev = $(_layColumn).prev();
        _layColumn[0].style.height = _prev[0].clientHeight + 'px';
      }

      _addNewBlock(self) {
        var _column = self.parentNode;
        var _nodeId = this._addTreeNodes({ parentId: _column.id, name: 'block' });
        var _blockId = _nodeId ? 'block_' + _nodeId : '';
        var _nodeId2 = this._addTreeNodes({ parentId: _blockId, name: 'column' });
        var _colId = _nodeId2 ? 'col_' + _nodeId2 : '';
        // $(_column).append('<div class="lay_block row"><div class="col-md-12 lay_column"><div class="grid-stack"></div><operation-menu></operation-menu></div></div>');
        var _layBlock = $('<div class="lay_block row" id="' + _blockId+ '"><div class="col-md-12 lay_column" width="12" id="' + _colId+ '"><div class="grid-stack"></div><operation-menu></operation-menu></div></div>');
        $(_column).append(_layBlock);
        var _grid = _layBlock[0].querySelector('.grid-stack');
        this._initAddGridstack(_grid);
      }

      _addNewField(self, name) {
        var _column = self.parentNode;
        var _grid = _column.querySelector('.grid-stack');
        var _newField = $(_grid).data('gridstack');
        var {html, width} = this._getWidget(name);
        if (html) {
          name = Utils.firstUpperCase(name);
          var _nodeId = this._addTreeNodes({ parentId: _column.id, name: name });
          this.isFormShown = false;
          _newField.addWidget($('<div class="grid-stack-item" id="item_' + _nodeId + '"><div class="grid-stack-item-content"><remove-widget-link></remove-widget-link>'+ html +'</div></div>'),
              1, 1, width, 1, true);
        }
      }

      _initAddGridstack(grid) {
        var options = {
            float: false,
            width: 12,
            acceptWidgets: '.grid-stack-item',
            draggable: {
              handle: '.grid-stack-item-content',
              scroll: false,
              appendTo: 'parent'
            }
        };
        $(grid).gridstack(options);
        // console.log($(grid).data('gridstack'));
        var _controlTree = this.root.querySelector('control-tree');
        var _this = this;
        // $(grid).on('dragstart', function(event, ui) {
        //
        // });
        $(grid).on('added', function(event, items) {
          for (var i = 0; i < items.length; i++) {
            var element = items[i].el[0];
            var parentEl = element.parentNode.parentNode;
            // var node = $(element).data('_gridstack_node');
            // console.log(element.id, parentEl.id);
            _controlTree.moveTreeNode(parentEl.id, element.id);
          }
        });
      }

      _removeColumn(self) {
        var _column = self.parentNode;
        var _block = _column.parentNode;
        var _columns = $(_block).find('>.lay_column');
        var _this = this, _col = 12;
        if (_columns.length) {
          var _isParent = _block.parentNode.classList.contains('tab-content');
          if (_columns.length > 1) {
            _column.remove();
            this._removeTreeNodes(_column.id, 1);
          }
          if (!_isParent && _columns.length == 1) {
            _block.remove();
            this._removeTreeNodes(_block.id, 1);
          }
          _columns = $(_block).find('>.lay_column');
          _col = 12 / _columns.length;
          _columns.each(function(i, column){
            var _list = _this._setColumnWidth(column.classList, _col);
            column.className = _list;
            column.setAttribute('width', _col);
          });
        }
      }

      _setColumnWidth(list, _col) {
        var _updateClass = list.value;
        list.forEach(function(item){
          if (item.indexOf('col-') > -1) {
            var _class = list.item(item.indexOf('col-'));
            var arr = _class.split('-');
            arr[arr.length - 1] = _col;
            _updateClass = _updateClass.replace(_class, arr.join('-'));
          }
        });
        return _updateClass;
      }

      _saveColumn() {
        var _serialize = {columns: []};
        var _form = this.$.formDesign, _preview = this.$.designPreview;
        var _outBlock = $(_form).children()[0];
        var _layBlock = _preview.querySelector('.lay_block');
        var _columns = this._getSerializeColumns(_outBlock);
        _layBlock.innerHTML = null;
        // console.log(JSON.stringify(_columns));
        // var _colString = '[{"width":"6","classList":{"0":"col-md-6","1":"lay_column"},"blocks":[{"block":1,"columns":[{"width":"6","classList":{"0":"col-md-6","1":"lay_column"},"blocks":[],"controls":[{"Category":"Input","filed":1,"Position":{"x":0,"y":0},"Size":{"width":2,"height":1}}]},{"width":"6","classList":{"0":"col-md-6","1":"lay_column"},"blocks":[],"controls":[{"Category":"Input","filed":1,"Position":{"x":0,"y":0},"Size":{"width":2,"height":1}}]}]}],"controls":[]},{"width":"6","classList":{"0":"col-md-6","1":"lay_column"},"blocks":[],"controls":[{"Category":"Input","filed":1,"Position":{"x":0,"y":0},"Size":{"width":2,"height":1}}]}]';
        // var _columns = JSON.parse(_colString);
        // console.log(_columns);

        this._previewColumns(_columns, _layBlock);
      }

      _previewColumns(columns, _preview) {
        var _this = this;
        // generate columns
        columns.forEach(function(column, i){
          // console.log(column);
          var {blocks, controls} = column;
          // new column grid-stack
          var _addCol = $('<div class="col-md-' + column.width + ' lay_column" width=' + column.width + ' id="' + ''+ '"><div class="grid-stack"></div></div>');
          $(_preview).append(_addCol);
          var _grid = _addCol[0].querySelector('.grid-stack');
          var options = {
              float: false,
              width: 12,
              draggable: {
                handle: '.grid-stack-item-content',
                scroll: false,
                appendTo: 'parent'
              }
          };
          $(_grid).gridstack(options);
          var _colGrid = $(_grid).data('gridstack');

          // generate controls
          controls.forEach(function(control, j){
            // console.log(control);
            var {html, width} = _this._getWidget(control.Category);

            if (html) {
              var start = html.indexOf('<'), end = html.indexOf('>');
              var el1 = document.createElement(html.substring(start + 1, end));
              for (var key in control) {
                el1[key] = control[key];
              }
              el1.isFormShown = true;
              var _gridItem = $('<div class="grid-stack-item"></div>'), _itemContent = $('<div class="grid-stack-item-content"></div>');
              _itemContent.append(el1);
              _gridItem.append(_itemContent);
              _colGrid.addWidget(_gridItem, control.Position.x, control.Position.y, control.Size.width, control.Size.height);
              _colGrid.disable();
            }
          });

          // generate blocks
          blocks.forEach(function(block, j){
            var _layBlock = $('<div class="lay_block row"></div>');
            _addCol.append(_layBlock);
            if (block.columns) {
              _this._previewColumns(block.columns, _layBlock[0]); // generate columns
            }
          });
        });
      }

      _getSerializeColumns(outBlock) {
        var _columns = [];
        var _this = this;
        // get columns under block
        outBlock && $(outBlock).find('>.lay_column').each(function(i, column){
          var _width = column.getAttribute('width'), _classList = column.classList;

          // get field controls under column
          var _childControls = _.map($(column).find('>.grid-stack > .grid-stack-item'), function(item, k) {
            var control = item.firstChild.lastChild;
            // console.log(control);
            var node = $(item).data('_gridstack_node');
            return {Category: control.Category, filed: k + 1, Position: {x: node.x, y: node.y}, Size: {width: node.width, height: node.height}};
          })

          // get blocks under column
          var _childBlocks = _.map($(column).find('>.lay_block'), function(block, k) {
            var childCols = _this._getSerializeColumns(block);  //// get columns under block
            return {block: k + 1, columns: childCols};
          });

          _columns.push({width: _width, classList: _classList, blocks:_childBlocks, controls: _childControls});
        });
        console.log(_columns);
        return _columns;
      }

      _addTreeNodes(param) {
        var _tree = this.root.querySelector('control-tree');
        return _tree.addTreeNodes(param);
      }

      _removeTreeNodes(parentId, flag) {
        var _tree = this.root.querySelector('control-tree');
        _tree.removeTreeNodes(parentId, flag);
      }

      _selectControl(e) {
        var {treeId} = e.detail;
        if (treeId) {
          this._clearActiveItem();
          var _activeItem = this.root.querySelector('#item_' + treeId + ' .grid-stack-item-content');
          if (_activeItem) {
            _activeItem.classList.add('active');
          }
        }
      }
    }

    window.customElements.define(FormDesignPage.is, FormDesignPage);
  </script>
</dom-module>
