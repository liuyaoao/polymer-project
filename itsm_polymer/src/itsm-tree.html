<!DOCTYPE html>
<HTML>
<HEAD>
	<TITLE> ZTREE DEMO - beforeDrag / onDrag / beforeDrop / onDrop</TITLE>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="stylesheet" href="../css/tree-css/demo.css" type="text/css">
	<link rel="stylesheet" href="../css/tree-css/zTreeStyle/zTreeStyle.css" type="text/css">
	<script type="text/javascript" src="../js/tree-js/jquery-1.4.4.min.js"></script>
	<script type="text/javascript" src="../js/tree-js/jquery.ztree.core.js"></script>
	<script type="text/javascript" src="../js/tree-js/jquery.ztree.excheck.js"></script>
	<script type="text/javascript" src="../js/tree-js/jquery.ztree.exedit.js"></script>
	<style>
		.btn {
			display: flex;
		}
		.btns {
			width: 60px;
			background-color: #61c179;
			color: #fff;
			height: 30px;
			line-height: 30px;
			text-align: center;
			margin-left: 10px;
			margin-top: 10px;
			font-size: 14px;
			padding:0 10px;
			cursor: pointer;
			border-radius: 2px;
		}
		.btns:active {
			background-color: #93c47d;
		}

	</style>
	<SCRIPT type="text/javascript">
		var setting = {
			view: {
				fontCss: getFont,
				nameIsHTML: true
			},
			edit: {
				drag: {
					autoExpandTrigger: true,
					prev: dropPrev,
					inner: dropInner,
					next: dropNext
				},
				enable: true,
				showRemoveBtn: false,
				showRenameBtn: false
			},
			data: {
				simpleData: {
					enable: true
				}
			},
			callback: {
				beforeDrag: beforeDrag,
				beforeDrop: beforeDrop,
				beforeDragOpen: beforeDragOpen,
				onDrag: onDrag,
				onDrop: onDrop,
				onExpand: onExpand,
				onClick: onClick
			}
		};

		function getFont(treeId, node) {
			return node.font ? node.font : {};
		}

		function dropPrev(treeId, nodes, targetNode) {
			var pNode = targetNode.getParentNode();
			if (pNode && pNode.dropInner === false) {
				return false;
			} else {
				for (var i=0,l=curDragNodes.length; i<l; i++) {
					var curPNode = curDragNodes[i].getParentNode();
					if (curPNode && curPNode !== targetNode.getParentNode() && curPNode.childOuter === false) {
						return false;
					}
				}
			}
			return true;
		}
		function dropInner(treeId, nodes, targetNode) {
			if (targetNode && targetNode.dropInner === false) {
				return false;
			} else {
				for (var i=0,l=curDragNodes.length; i<l; i++) {
					if (!targetNode && curDragNodes[i].dropRoot === false) {
						return false;
					} else if (curDragNodes[i].parentTId && curDragNodes[i].getParentNode() !== targetNode && curDragNodes[i].getParentNode().childOuter === false) {
						return false;
					}
				}
			}
			return true;
		}
		function dropNext(treeId, nodes, targetNode) {
			var pNode = targetNode.getParentNode();
			if (pNode && pNode.dropInner === false) {
				return false;
			} else {
				for (var i=0,l=curDragNodes.length; i<l; i++) {
					var curPNode = curDragNodes[i].getParentNode();
					if (curPNode && curPNode !== targetNode.getParentNode() && curPNode.childOuter === false) {
						return false;
					}
				}
			}
			return true;
		}

		var log, className = "dark", curDragNodes, autoExpandNode;
		function beforeDrag(treeId, treeNodes) {
			className = (className === "dark" ? "":"dark");
			showLog("[ "+getTime()+" beforeDrag ]&nbsp;&nbsp;&nbsp;&nbsp; drag: " + treeNodes.length + " nodes." );
			for (var i=0,l=treeNodes.length; i<l; i++) {
				if (treeNodes[i].drag === false) {
					curDragNodes = null;
					return false;
				} else if (treeNodes[i].parentTId && treeNodes[i].getParentNode().childDrag === false) {
					curDragNodes = null;
					return false;
				}
			}
			curDragNodes = treeNodes;
			return true;
		}
		function beforeDragOpen(treeId, treeNode) {
			autoExpandNode = treeNode;
			return true;
		}
		function beforeDrop(treeId, treeNodes, targetNode, moveType, isCopy) {
			className = (className === "dark" ? "":"dark");
			showLog("[ "+getTime()+" beforeDrop ]&nbsp;&nbsp;&nbsp;&nbsp; moveType:" + moveType);
			showLog("target: " + (targetNode ? targetNode.name : "root") + "  -- is "+ (isCopy==null? "cancel" : isCopy ? "copy" : "move"));
			return true;
		}
		function onDrag(event, treeId, treeNodes) {
			className = (className === "dark" ? "":"dark");
			showLog("[ "+getTime()+" onDrag ]&nbsp;&nbsp;&nbsp;&nbsp; drag: " + treeNodes.length + " nodes." );
		}
		function onDrop(event, treeId, treeNodes, targetNode, moveType, isCopy) {
			className = (className === "dark" ? "":"dark");
			showLog("[ "+getTime()+" onDrop ]&nbsp;&nbsp;&nbsp;&nbsp; moveType:" + moveType);
			showLog("target: " + (targetNode ? targetNode.name : "root") + "  -- is "+ (isCopy==null? "cancel" : isCopy ? "copy" : "move"))
		}
		function onExpand(event, treeId, treeNode) {
			if (treeNode === autoExpandNode) {
				className = (className === "dark" ? "":"dark");
				showLog("[ "+getTime()+" onExpand ]&nbsp;&nbsp;&nbsp;&nbsp;" + treeNode.name);
			}
		}
		function onClick(event, treeId, treeNode, clickFlag) {
      getParent().currentTreeNode = treeNode;
      getParent().treeObjCopy = _clone(treeNode);
			console.log(JSON.stringify(treeNode));
      var parent = treeNode.getParentNode();
      if(parent){
				if (treeNode.otype == 'field') {
					getParent()._editPanelDrawerOpen('editDrawer1_1');
				} else if(parent.otype == 'field'){
					getParent()._editPanelDrawerOpen('editDrawer1');
				}
				if (treeNode.otype == 'relate') {
					getParent()._editPanelDrawerOpen('editDrawer2_1');
				} else if(parent.otype == 'relate'){
					getParent()._editPanelDrawerOpen('editDrawer2');
				}
				if(treeNode.otype == 'show'){
					console.log("show drawer");
					getParent()._editPanelDrawerOpen('editDrawer4_1');
				} else if(parent.otype == 'show'){
					var type = treeNode.name;
					var type2 = treeNode.otype;
					if (type2 == 'layout') {
						getParent()._editPanelDrawerOpen('editDrawer3');
					}
					if (type2 == 'grid') {
						getParent()._editPanelDrawerOpen('editDrawer4');
					}
				}
				if(treeNode.otype == 'field' || treeNode.otype == 'relate' || treeNode.otype == 'show'){
					getParent().currentTreeNodeParent = treeNode;
				} else {
					getParent().currentTreeNodeParent = parent;
				}
      } else {
        getParent()._editPanelDrawerOpen('editDrawer0');
      }

		}
		function showLog(str) {
			console.log(str);
		}
		function getTime() {
			var now= new Date(),
			h=now.getHours(),
			m=now.getMinutes(),
			s=now.getSeconds(),
			ms=now.getMilliseconds();
			return (h+":"+m+":"+s+ " " +ms);
		}

		function setTrigger() {
			var zTree = $.fn.zTree.getZTreeObj("treeDemo");
			zTree.setting.edit.drag.autoExpandTrigger = $("#callbackTrigger").attr("checked");
		}

		function loadTreeObj(){
			var tree = getTreeObj();
			if (tree) {
				tree.destroy();
			}
			var token = getToken();
			console.log('token:' + token);
			// var uri = Window.AppConfig.serverUrl+"/foundation/api/v1/businessobject/getById?token=" + token + "&id=CD241021FB7646428021AD547CDB2F6C";
			var uri = "http://192.168.9.81:8080/foundation/api/v1/businessobject/getById?token=" + token + "&id=CD241021FB7646428021AD547CDB2F6C";
			$.ajax({
        type: "GET",
        // url: Window.AppConfig.serverUrl+"/foundation/api/v1/businessobject/list?token=12",E3A48E9C8ACA4E688BD49368DC80691E
        // url: Window.AppConfig.serverUrl+"/foundation/api/v1/businessobject/getById?token=adadf&id=CD241021FB7646428021AD547CDB2F6C",
        url: uri,
        async : true,
        success: function(data){
          // console.log(data);
					if(data.msg){
						console.log(data.msg);
					} else {
						var jsonData = JSON.parse(data);
	          getParent().serverData = jsonData;
						// console.log(JSON.stringify(getParent().serverData.LayoutDef));
	          // console.log(JSON.stringify(jsonData.BusinessObjectDef.fields[25]));
	          // console.log(JSON.stringify(jsonData.BusinessObjectDef.fields[7]));
	          var zNodes = [];
	          //涓氬姟瀵硅薄
	          var business = _clone(jsonData.BusinessObjectDef);
	          business.isParent = true;
	          business.children = [];
						business.otype = 'business';
	          //瀛楁
	          var field = { name:"字段", otype:"field", isParent:true};
	          field.children = business.fields;

	          // console.log(JSON.stringify(business.fields));
	          business.fields = [];//娓呴櫎涓氬姟瀵硅薄涓婂瓧娈垫暟鎹�
	          //鍏崇郴
	          var relate = { name:"关系", otype:"relate", isParent:true};
	          relate.children = jsonData.RelationshipDef;
	          //鏄剧ず
	          var show = { name:"显示", otype:"show", isParent:true};
	          show.children = [];
	          //绐椾綋
	          var panel = jsonData.PanelDef;
	          //甯冨眬
	          var layout = jsonData.LayoutDef;
	          //缃戞牸
	          var grid = jsonData.GridDef;

	          for(var i=0;i<panel.length;i++){
	            panel[i].name += '(窗体)';
	            panel[i].otype = 'panel';
	            show.children.push(panel[i]);
	          }
	          for(var i=0;i<layout.length;i++){
	            layout[i].name += '(布局)';
	            layout[i].otype = 'layout';
	            show.children.push(layout[i]);
	          }
	          for(var i=0;i<grid.length;i++){
	            grid[i].name += '(网格)';
	            grid[i].otype = 'grid';
	            show.children.push(grid[i]);
	          }

	          business.children.push(field);
	          business.children.push(relate);
	          business.children.push(show);

	          zNodes.push(business);

	          $.fn.zTree.init($('#treeDemo'), setting, zNodes);
						$("#callbackTrigger").bind("change", {}, setTrigger);
					}
        },
        error: function(xhr,status,error){
          console.log("错误信息：" + xhr.status + " " + xhr.statusText);
        }
      });
		}

		$(document).ready(function(){
			loadTreeObj();
		});

		function getTreeObj(){
			return $.fn.zTree.getZTreeObj("treeDemo");
		}

		function getParent(){
			return window.parent.document.querySelector('news-app').shadowRoot.querySelector('app-page').shadowRoot.querySelector('itsm-business');
		}

		function getToken(){
			return getParent()._getToken();
			// return "18C7D8D0FEF44FC1BA21B858F13AE0FC";
		}

		//鍏嬮殕瀵硅薄
    function _clone(Obj){
      var buf;
			if(Obj instanceof Array){
				buf = [];
				var i = Obj.length;
				while(i--){
					buf[i] = _clone(Obj[i]);
				}
				return buf;
			} else if(Obj instanceof Object){
				buf = {};
				var flag = false;
				for(var k in Obj){
					if (!flag) {
						flag = true;
					}
					buf[k] = _clone(Obj[k]);
				}
				if (!flag) {
					buf = null;
				}
				return buf;
			} else {
				return Obj;
			}
    }

		function addTreeNode(e){
			var node = e.detail;
			var treeObj = getTreeObj();
			if(treeObj.getNodesByParam("name", node.name, getParent().currentTreeNodeParent).length > 0){
				alert('字段名称['+node.name+']已存在！');
			} else {
				node.font = {'color':'green'};
				treeObj.addNodes(getParent().currentTreeNodeParent, node);
				treeObj.selectNode(node);
				var childarr = getParent().currentTreeNodeParent.children;
				treeObj.selectNode(childarr[childarr.length-1]);
				var cnode = childarr[childarr.length-1];
				setDirty(cnode);
				if (!getParent().currentTreeNodeParent.font) {
					getParent().currentTreeNodeParent.font = {'color':'green'};
					treeObj.updateNode(getParent().currentTreeNodeParent);
				}
			}
		}

		function updateNode(e){
			var treeObj = getTreeObj();
			getParent().currentTreeNode.font = {'color':'red'};
			treeObj.updateNode(getParent().currentTreeNode);
			setDirty(getParent().currentTreeNode);
			if (!getParent().currentTreeNodeParent.font || getParent().currentTreeNodeParent.font.color == 'green') {
				getParent().currentTreeNodeParent.font = {'color':'red'};
				treeObj.updateNode(getParent().currentTreeNodeParent);
			}
		}

		function setDirty(node){
			var parent = node.getParentNode();
			node.isDirty = true;
			if (parent != null) {
				if(parent.otype == 'field' || parent.otype == 'relate' || parent.otype == 'show'){
					parent.isDirty = true;
				}
				setDirty(parent);
			} else {
				if(!node.isDirty){
					node.isDirty = true;
				}
			}
		}

		//根据深度来获取变脏节点：level 0表示根节点；1表示2级节点
		function getDirtyNodes(level){
			function filter(node){
				return (node.level == level && node.isDirty == true);
			}
			var nodes = getTreeObj().getNodesByFilter(filter);
			return nodes;
		}

		//获取变脏的关系节点
		function getDirtyRelateNodes(){
			function filter(node){
				return (node.level == 3 && node.isDirty == true && node.getParentNode().otype == 'relate');
			}
			return getTreeObj().getNodesByFilter(filter);
		}

		//根据otype获取变脏的显示节点
		function getDirtyShowNodes(otype){
			function filter(node){
				return (node.level == 3 && node.isDirty == true && node.otype == otype);
			}
			return getTreeObj().getNodesByFilter(filter);
		}

		function createOrUpdateBusinessObject(edata){
			$.ajax({
				type: "POST",
				// url: Window.AppConfig.serverUrl + "/foundation/api/v1/businessobject/createOrUpdate?token=" + getToken(),
				url: "http://192.168.9.81:8080/foundation/api/v1/businessobject/createOrUpdate?token=" + getToken(),
				data: JSON.stringify(edata),
				contentType: "application/json",
				dataType: "json",
				async : true,
				success: function(data){
					console.log(data);
				},
				error: function(xhr,status,error){
					console.log("错误提示： " + xhr.status + " " + xhr.statusText);
				}
			});
		}

		function getTreeRootNode(node){
			if (node.getParentNode() != null) {
				getTreeRootNode(node.getParentNode());
			}
			return node;
		}

		//删除节点
		function removeTreeNode(e){
	 　　//点击确定后操作
			var treeObj = getTreeObj();
			var nodes = treeObj.getSelectedNodes();
			for (var i=0, l=nodes.length; i < l; i++) {
				setDirty(nodes[i]);
				getTreeRootNode(nodes[i]).isDirty = true;
				treeObj.removeNode(nodes[i]);
			}
		}

		//清除字段上树属性
		function clearTreeProp(template, node){
			var temp = {};
			for(var n in template){
				temp[n] = node[n];
			}
			return temp;
		}

		function submit(){
			var result = {"BusinessObjectDef":[],"LayoutDef":[],"PanelDef":[],"RelationshipDef":[],"GridDef":[],"DelBusinessObjectDef":[],"DelLayoutDef":[],"DelPanelDef":[],"DelRelationshipDef":[],"DelGridDef":[]};
			var dirtyNodes = getDirtyNodes(0);
			//字段
			if(dirtyNodes.length > 0){
				var treeObj = getTreeObj();
				var pNode;
				for(var i=0;i<dirtyNodes.length;i++){
					var businessDefTemplate = _clone(getParent().serverData.BusinessObjectDef);
					pNode = dirtyNodes[i];
					for(var j in businessDefTemplate){
						if (!j == 'fields') {
							businessDefTemplate[j] = pNode[j];
						}
					}
					var fields = businessDefTemplate.fields;
					fields.splice(0,fields.length);
					$.ajaxSettings.async = false;
					$.getJSON('/../data/template.json', function(data){
						var pField = treeObj.getNodesByParam('otype', 'field', pNode);
						for(var m=0;m<pField.length;m++){
							var busFields = pField[m].children;
							for(var k=0;k<busFields.length;k++){
								var field = busFields[k];
								switch (field.fieldCategory) {
									case 4:
										fields.push(clearTreeProp(data.fieldTemplate.textFieldTemplate, field));
										break;
									case 8:
										fields.push(clearTreeProp(data.fieldTemplate.numberFieldTemplate, field));
										break;
									case 32:
										fields.push(clearTreeProp(data.fieldTemplate.timeFieldTemplate, field));
										break;
									default:
										break;
								}
							}
						}
					});
					$.ajaxSettings.async = true;
					result.BusinessObjectDef.push(businessDefTemplate);
					// createOrUpdateBusinessObject(businessDefTemplate);
				}
			} else {
				console.log("no change");
			}
			//关系
			var dirtyRalate = getDirtyRelateNodes();
			//窗体
			var dirtyPanel = getDirtyShowNodes('panel');
			//布局
			var dirtyLayout = getDirtyShowNodes('layout');
			//网格
			var gridLayout = getDirtyShowNodes('grid');

		}
	</SCRIPT>
</HEAD>

<BODY>
<script src="../config.js"></script>
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<div class="btn">
	<div class="btns" onclick="loadTreeObj()">refresh</div>
	<div class="btns" onclick="submit()">submit</div>
</div>
<div class="content_wrap">
	<div class="zTreeDemoBackground left">
		<ul id="treeDemo" class="ztree"></ul>
	</div>
</div>
</BODY>
</HTML>
