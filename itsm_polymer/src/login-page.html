<link rel="import" href="../bower_components/polymer/polymer-element.html">
<!-- <link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../bower_components/iron-input/iron-input.html"> -->
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<script src="../node_modules/js-base64/base64.js"></script>
<link rel="import" href="css/page-styles.html">

<link rel="import" href="./redux/actions/userLogin-mixin.html">

<dom-module id="login-page">

  <template>
    <style include="page-styles">
    </style>
    <div class="login_bg">
      <h1 title="SiteView ITOSS IT运营支持平台"><img src="../images/slogo.svg" alt=""></h1>
      <div class="content">
        <div class="login_form">
          <h2>ITOSS IT运营支撑平台</h2>
          <div class="form-container">
            <paper-input id="username" label="请输入用户名" value="{{username}}" error-message="用户名错误!" tabindex="1">
              <paper-icon-button slot="prefix" src="../images/icon-user.png">
              </paper-icon-button>
            </paper-input>
            <paper-input id="pwd" label="请输入密码" value="{{pwd}}" type="{{pwdType}}" tabindex="2">
              <paper-icon-button slot="prefix" src="../images/icon-pw.png">
              </paper-icon-button>
            </paper-input>
            <div class="msg">默认用户名: [[defaultUserName]] 密码：[[defaultUserPwd]]</div>
            <div class="checkboxs">
              <paper-checkbox id="rememberPwd">记住密码</paper-checkbox>
              <paper-checkbox on-change="_onClickShowPwd" id="isShowPwd">显示密码</paper-checkbox>
            </div>
            <paper-button class="login_btn" on-click="_submitLogin">
              <div class="text">
                登录
              </div>
            </paper-button>
          </div>

        </div>
      </div>
      <p class="copyRight">版权所有 北京游龙网网络科技有限公司</p>
    </div>
  </template>

  <script>
    class LoginPage extends UserLoginMixin(Polymer.Element) {
      static get is() { return 'login-page'; }
      static get properties() {
        return {

          username: {
            type: String,
            notify: true,
            reflectToAttribute: true
          },

          pwd: String,

          pwdType: {
            type: String,
            value: "password"
          },

          defaultUserName: {
            type: String,
            value: Window.AppConfig.defaultUserName
          },

          defaultUserPwd: {
            type: String,
            value: Window.AppConfig.defaultPwd
          },
        };
      }

      ready(){
        super.ready();

        var storage=window.localStorage;
        if(storage.username){
          this.username = storage.username;
          // $(this.$.pwd).addAttr("focused",true);
        }else{
          // $(this.$.username).addAttr("focused",true);
        }

        if(storage.userInfo){
          var arr = JSON.parse(storage.getItem("userInfo"));
          this.dispatch("setUserInfo", arr.loginId, arr.token);
        }
        //回车 -- 登录
        this.addEventListener('keypress', this._pressEnter.bind(this));

      }

      _pressEnter(e){
        if(e.keyCode == 13){
          this._submitLogin();
        }
      }

      _submitLogin(){
        var _this = this;
        var storage=window.localStorage;
        var username = $.trim(_this.username), pwd = $.trim(_this.pwd);
        console.log("登录接口",Window.AppConfig.serverUrl+"/foundation/api/v1/auth/login");
        var data = {
          "user": username,
          "password": Base64.encode(pwd)
        };
        $.ajax({
          type: "POST",
          url: Window.AppConfig.serverUrl+"/foundation/api/v1/auth/login",
          async : true,
          contentType: "application/json",
          dataType: "json",
          data: JSON.stringify(data),
          success: function(data){
            var arr = data;
            if(arr.code){
              alert(arr.msg);
            }else{
              if(arr.currentRole === null){
                var userInfo = {userId: arr.loginId, userToken: arr.token};
                _this.dispatch("setUserInfo", arr.loginId, arr.token);
                _this.dispatch("getUserRoles", arr.userRoles);

                storage.setItem('userInfo', JSON.stringify(userInfo));

                window.history.pushState({}, null, "/app/loginRole");
                window.dispatchEvent(new CustomEvent('location-changed'));
              }
            }
            //记住密码
            // _this._rememberPwd();
          },
          error: function(error){
            console.log("errorMsg",error);
          }
        });
      }

      _onClickShowPwd(e){
        if(this.$.isShowPwd.checked){
          this.pwdType = "";
        }else{
          this.pwdType = "password";
        }
      }

      _rememberPwd(){
        var storage=window.localStorage;
        if(this.$.rememberPwd.checked){
          storage.username = this.username;
        }else{
          storage.clear();
        }
      }

      _focusInput() {
        var _input = this.root.querySelector('input');
        // console.log(_input);
        if (_input) {
          _input.focus();
        }
      }

      _removeWidget(e) {
        var gridItem = this.parentNode.parentNode;
        // console.log(gridItem);
        if (gridItem.classList.contains('grid-stack-item')) {
          this.dispatchEvent(new CustomEvent('remove-widget', {detail: gridItem, bubbles: true, composed: true}));
        }

      }

    }

    window.customElements.define(LoginPage.is, LoginPage);
  </script>
</dom-module>
