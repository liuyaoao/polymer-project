
<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/app-layout/helpers/helpers.html">
<link rel="import" href="../../bower_components/app-layout/app-layout.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="../news-data.html">
<link rel="import" href="cms-header.html">
<link rel="import" href="cms-nav-left.html">

<link rel="import" href="styles-themes.html" async>
<!-- <link rel="import" href="../news-analytics.html"> -->
<!-- <link rel="import" href="../news-drawer.html"> -->
<!-- <link rel="import" href="../news-network-warning.html"> -->
<link rel="import" href="../news-snackbar.html">

<!-- <link rel="import" href="../../bower_components/app-layout/app-box/app-box.html"> -->
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<dom-module id="cms-page">

  <template>

    <style>

      :host {
        display: block;
        position: relative;

          text-align: left;
        }
        :host .page_cnt_container{
          margin-left:240px;
          /*width:100%;*/
          transition: margin-left 0.5s ease-in-out;
        }

        iron-pages {
          /*max-width: 1440px;*/
          margin: 0 auto;
        }

        footer {
          position: absolute;
          bottom: 0;
          right: 0;
          left: 0;
          padding-bottom: 24px;
          text-align: center;
        }

        footer a {
          text-decoration: none;
          font-size: 13px;
          color: #757575;
        }

        footer a:hover {
          text-decoration: underline;
        }

        /* desktop */
        @media (min-width: 768px) {
          :host {
            /*margin: 0 40px;*/
          }
        }

    </style>

    <styles-themes is-app-root></styles-themes>
    <news-analytics key="UA-39334307-18"></news-analytics>
    <iron-media-query query="max-width: 767px" query-matches="{{smallScreen}}"></iron-media-query>
    <!--
      app-location and app-route elements provide the state of the URL for the app.
    -->
    <app-location route="{{location}}"></app-location>
    <app-route
        route="[[route]]"
        pattern="/:page"
        data="{{routeData}}"
        tail="{{subroute}}"></app-route>

    <!--
      news-data provides the list of categories and the articles for the category.
    -->
    <news-data
        id="data"
        categories="{{categories}}"
        category-name="[[categoryName]]"
        category="{{category}}"
        article-id="[[articleId]]"
        article="{{article}}"
        loading="{{loading}}"
        offline="[[offline]]"
        failure="{{failure}}"></news-data>

      <cms-header id="cmsHeader" app-title="[[appTitle]]">
        <div slot="cms_contentContainer" style="height:100%;position:relative;">
          <cms-nav-left
          id="navbarLeft"
          app-title="[[appTitle]]"
          current-panel="[[page]]"
          page-cnt-margin-left="{{pageCntMarginLeft}}">
        </cms-nav-left>
        <div class="page_cnt_container" style="margin-left:[[pageCntMarginLeft]];">
          <iron-pages role="cms_main" selected="[[page]]" attr-for-selected="name" fallback-selection="path-warning">
            <!-- list view of articles in a category -->
            <cms-modules
              id="modules"
              name="modules"
              route="[[subroute]]"
              category-name="{{categoryName}}"
              category-id="{{categoryId}}"
              category="[[category]]"
              loading="[[loading]]"
              offline="[[offline]]"
              failure="[[failure]]">
            </cms-modules>
            <cms-perspective
              id="perspective"
              name="perspective"
              route="[[subroute]]"
              category-name="{{categoryName}}"
              category-id="{{categoryId}}"
              category="[[category]]"
              loading="[[loading]]"
              offline="[[offline]]"
              failure="[[failure]]">
            </cms-perspective>
            <cms-businessobj id="businessobj" name="businessobj" route="[[subroute]]"></cms-businessobj>
            <cms-ruledefinition id="ruledefinition" name="ruledefinition" route="[[subroute]]"></cms-ruledefinition>
            <cms-datadefinition id="datadefinition" name="datadefinition" route="[[subroute]]"></cms-datadefinition>
            <cms-modeldefinition id="modeldefinition" name="modeldefinition" route="[[subroute]]"></cms-modeldefinition>
            <cms-layoutsetting id="layoutsetting" name="layoutsetting" route="[[subroute]]"></cms-layoutsetting>
            <!-- invalid top level paths -->
            <news-path-warning name="path-warning"></news-path-warning>
          </iron-pages>
        </div>
    </div>
      </cms-header>





    <footer>
      <a href="https://www.polymer-project.org/1.0/toolbox/">Made by Polymer</a>
    </footer>

  </template>

  <script>

    class CmsPage extends Polymer.Element {

      static get is() { return 'cms-page'; }

      static get properties() { return {

        appTitle: String,
        route:Object,
        page: {
          type: String,
          observer: '_pageChanged'
        },

        routeData: Object,

        categories: Array,

        categoryName: String,

        category: Object,

        articleId: String,

        article: Object,

        offline: {
          type: Boolean,
          value: false,
          readOnly: true
        },

        failure: Boolean,

        loadComplete: Boolean,

        categoryId: String

      }}

      static get observers() { return [
        '_routePageChanged(routeData.page, subroute)',
        '_updateDocumentTitle(page, category.title, appTitle)'
      ]}

      ready() {
        super.ready();
        // Custom elements polyfill safe way to indicate an element has been upgraded.
        this.removeAttribute('unresolved');

        Polymer.RenderStatus.afterNextRender(this, () => {
          window.addEventListener('online', (e)=>this._notifyNetworkStatus(e));
          window.addEventListener('offline', (e)=>this._notifyNetworkStatus(e));
        });
      }

      connectedCallback() {
        super.connectedCallback();
        // this.isAttached = true;
      }

      _routePageChanged(page,subroute) {
        let pathName = this.location.path;
        if (!page && (pathName == "/cms"||pathName == "/cms/")) {
          // set default route if route path is empty
          this.set('location.path', 'cms/modules');
          return;
        }
        this.page = page;
        // Scroll to the top of the page on every *route* change. Use `Polymer.AppLayout.scroll`
        // with `behavior: 'silent'` to disable header scroll effects during the scroll.
        Polymer.AppLayout.scroll({ top: 0, behavior: 'silent' });
      }

      _pageChanged(page, oldPage) {
        let href;

        switch(page) {
          case 'modules':
            href = 'cms-modules.html';
          break;
          case 'perspective':
            href = 'cms-perspective.html';
          break;
          case 'businessobj': //业务对象
            href = 'cms-businessobj.html';
          break;
          case 'ruledefinition': //规则定义
            href = 'cms-ruledefinition.html';
          break;
          case 'datadefinition':  //数据结果集定义
            href = 'cms-datadefinition.html';
          break;
          case 'modeldefinition':  //数据模型定义
            href = 'cms-modeldefinition.html';
          break;
          case 'layoutsetting':  //门户布局
            href = 'cms-layoutsetting.html';
          break;
          default:
            href = '../news-path-warning.html';
          break;
        }
        let cb = this._pageLoaded.bind(this, Boolean(oldPage));
        Polymer.importHref(this.resolveUrl(href), cb, cb, true);
      }

      _pageLoaded(shouldResetLayout) {
        // console.log("cms-page-----_ensureLazyLoaded");
        // this._ensureLazyLoaded();
      }

      // Elements in the app can notify section changes.
      // Response by a11y announcing the section and syncronizing the category.
      _updateDocumentTitle(page, categoryTitle, appTitle) {
        let pageNameMap = {
            "modules":"应用",
            "perspective":"透视",
            "businessobj":"业务对象",
            "ruledefinition":"规则定义",
            "datadefinition":"数据结果集定义",
            "modeldefinition":"数据模型定义",
            "layoutsetting":"门户布局"}
        document.title = pageNameMap[page] + ' - ' + appTitle;
      }

    }

    customElements.define(CmsPage.is, CmsPage);

  </script>

</dom-module>
